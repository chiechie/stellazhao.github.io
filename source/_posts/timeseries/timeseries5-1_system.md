---
title: 时间序列5-1 时序预测框架--《Probabilistic Demand Forecasting at Scale》
author: chiechie
mathjax: true
date: 2021-07-27 11:35:00
tags: 
- 最佳实践
- 人工智能
- 时序预测
- 量化交易
- 读书笔记
categories: 
- 时间序列
---

> 本文设计了一个时序预测系统，针对大规模时序进行预测

# 要点

1. 对大规模时序预测，工业界一直**研究不足**
2. 一般的模型开发和部署的流程：算法人员在实验环境使用一套语言（例如keras）快速实验。工程人员在生产环境将模型重新实现一遍并上线。
3. 难点在于系统层面，又要 稳定 又要 灵活。提升稳定性的代价是代码复杂度上升，缺少抽象导致没法快速实验。
4. 本文提出了一个时序预测的框架，并且支持四种建模范式：local(数据并行)/global(最简单)/local with 人工指定分组/global and local(人工不指定分组，给出商品的元信息，让模型去学)
5. 本文的解决方案--将工程人员的工作沉淀为平台工具，如:

  - 提供了数据处理的high-leve API：用户只用指定dataflow的数据源，处理的逻辑流，背后真正执行的数据流（一个DAG）会被系统重写（优化计算效率）
  - 后台支持四种模型训练范式
  - 后台支持分布式学习
  - 使用层面：实验阶段 希望快速出结果 ，生产阶段希望自动化地配置各种任务，包括自动化搜索超参
  - 算法层面：抽象出了路由功能 和 集成功能，使用命令式编程的方式 就可以实现 1. 给每个算法or策略分配 sub group样本用来训练， 2 给每个sub group 分配多个算法，并指定集成的权重）

6. 本方法的收益：支持大规模训练；算法和工程分开。
7. 可伸缩性(可扩展性)：评价系统处理能力的一种指标。高可伸缩性表示，通过很少的改动甚至只添加硬件，就能实现整个系统处理能力的线性增长。
8. 实际中的需求：

   - 预测某个类别商品（比如厨具）的销量。
   - 历史数据缺失比较常见：比如某段时间，商品卖脱销了/有些商品停产了
   - 圣诞节前几周，销量可能会上升（跟商品自己无关）
   - 对高销量（看每周的平均销量 在所有商品中的排名）商品，使用混合策略，各自权重为0.5：baseline 模型和GLM模型
   - 对系统的自动化需求：在生产阶段会用到集群，服务的可用性有严格的标准。自动化的模型选择，自动的模型更新（固定特征集，超参），自动化的模型集成策略。

9. 一些最佳实践

   - 新发布一个模型之前要回测
   - 面对众多需要预测的商品时，使用二八原则，80%不重要的商品（例如历史数据稀疏），使用cheap解决方案（baseline 模型），20%重要的商品，使用expensive解决方案（nn，集成模型）
   - 对没有被路由到的商品，使用baseline模型兜底
   - 如果单个learner失败了，使用该leaner的商品就预测不出来了，使用ensemble策略比较好
   - 在模型开发的整个生命周期：先尝试小范围的baseline模型，后面不断的对特定的商品子类（subset）添加 specialized learners，来提升准确率（why 保证提升？）
   - 分组训练怎么保证准确率？将error tolerance 设置很小，将num_iteration设置为一个固定的较大的值。
   - 如果又想要在不同曲线之间迁移，又想保持曲线各自的特点，可以这么做：将共享的向量弄小一点，或者 提供自由度：让每个曲线都选择自己的特征。

# 附录

## 问题

- 预测多个时序，使用全局模型和局部模型，系统后台分别是怎么设计的？为什么要这么设计?
- 时序预测的后台能否拓展到其他场景，或者更general 的机器学习场景中？
- 预处理 和 特征转换 阶段，专门针对时序数据做了哪些改进？提供了哪些算子？
- 参数服务器是数据平行还是模型并行？


## 概率模型的输出

![时序预测需求](https://firebasestorage.googleapis.com/v0/b/firescript-577a2.appspot.com/o/imgs%2Fapp%2Frf_learning%2Fsg4v0LRFEh.png?alt=media&token=ec469b3d-4912-4f27-9e1d-080f37bb27fa)

- 黑色：观测值
- 绿色：训练阶段，0.9 和 0.1 的分位数
- 红色：未知数据上推断，0.9 和 0.1 的分位数

## 系统架构

![](https://firebasestorage.googleapis.com/v0/b/firescript-577a2.appspot.com/o/imgs%2Fapp%2Frf_learning%2FdxvYHgGI4v.png?alt=media&token=ebc71e8e-6863-42d3-8b2c-e5f8159c2a8d)



## 数据处理API

让用户只用关心 数据源，算子组装  逻辑，平台会根据用户的声明式编程语言（declarative ），生成计算图（DAG）和 优化（合并相同计算逻辑，生成缓存节点）

![](https://firebasestorage.googleapis.com/v0/b/firescript-577a2.appspot.com/o/imgs%2Fapp%2Frf_learning%2FKE2kXC_eEL.png?alt=media&token=612d833e-359e-44d3-9f86-42d0c152d120)



# 参考

1. [基于概率的大规模需求预测](http://www.vldb.org/pvldb/vol10/p1694-schelter.pdf)
  
    
