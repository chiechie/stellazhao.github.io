---
title:  时间序列5 时序异常检测
author: chiechie
mathjax: true
date: 2021-04-01 23:12:28
tags:
- 时间序列
- 不相容需求
- 趋势回归
- 视角主义
categories:
- 时间序列
---

> I'm not an outlier; I just haven't found my distribution yet!



## 总结

1. 何为异常？正常的反面即异常。如果我们可以定义正常，那么异常就是其反面，很容易判断。
2. 如何定义正常？很多时间序列模型都可以，如arima/garch等，生成模型也可以。
3. 众多模式如何的选择？用拟合程度来判断，即找到一个最佳视角，能够解释当前的观测值。



## 附录

1. 如果群体本身就是一个mess，还有必要跟它对比吗？如果这个群体就是一个五花八门的, 很难说哪个异常，因为都很有个性。eg美国的拉美裔，女权团体。
2. 如果这个群体mostly有秩序，只有少部分个体表现的不符合这个秩序，这些人就是异常。
3. 可以通过预测群体的正常行为来做异常检测，换言之时序预测是一种做异常检测的方法。
4. 异常检测比预测更简单。异常检测只需自圆其说即可，时序预测需要拿现实数据来验证。
5. 异常检测分两步，先做模式识别，也就是找规律，然后判断当前数据是否符合规律，符合即正常，反之则为异常。
6. 不是所有的序列都可以预测，比如股票数据就不可预测，因为历史数据里面包含的信息有限。 但是天气很好预测，因为很有规律。但是「能不能由预测」这些元知识都是人类总结出来的，通过很短的历史数据很难挖掘出这样的认识。
7. 狭义的预测，即，上面的预测 是想要 排除掉 异常的场景的，比如 出现经融危机的时候，希望预测出来正常值，所以，上面的预测 跟 一般的时序预测 不一样，上面的 预测 是希望 观测数据（训练数据）  或者 说 评分指标 能过滤掉哪些 极端异常的情况。 
    - 但是 实际情况是，我们很难给到 最单纯的 观测数据，现实中由于设备或者 采集环境 的原因，得到的观测值 往往是 含有噪声的，那么进一步的，这个噪声也分为两种，一种是正常的噪声，一种是极端异常值（比如金融危机，或者整个系统瘫痪）。
    - 对于正常的噪声，我们希望能够捕捉它的范围，然后在 推断阶段，依葫芦画瓢，也认为观测值是模式 + 正常噪声的结果。
    - 对于极端异常值，我们希望在训练阶段屏蔽掉 该值的影响，然后在 推断阶段，能识别出 它是远离 正常噪声范围的。进而告警。
    8.又引申出新的问题，如何 分离出 一个观测值中的 趋势 + 噪声模式 + 极端值这三个分量？
    - 最直觉的方法 就是用stl的方法，基本原理 就是 待定系数法， 假设有3个函数组成（参数待估），然后用真实样本拟合（loss 应该是l2吧）。
    - 这种方法有一个问题，就是 拟合出来的趋势 经常是0，拟合出来的噪声经常是带有周期性的，并且也没法干预吼？
8. 异常检测只需要告知自己理解是啥；预测需要更进一步，考虑现实中的所有可能发生的情况。异常检测可以大胆地做，理论上没法证伪。预测是企业家的事情，需要一比高下。做异常检测是学术界的事情，选定一个视角，自己得出结论，不用跟别人一比高下。
9. 异常检测的原理是历史外延，没法证伪。如果预测和现实有偏差，碰巧能找到故障。如果找不到，也有可能是隐患，或者我们的视角有局限。没法证明是误判。
10. 一种异常检测器是一种视角，应该允许存在多个视角，并且可自由切换。
11. 什么样的告警结果用户可接受？符合他们认知模式的，比如同环比，上下界。
12. 时间序列相对于iid样本，生成机制不一样。时间序列比如人在不同时刻的行为序列，是有延续的。iid的数据比如，体育彩票，每一期中奖号码跟上一期没有关系。
13. iid的样本满足中心极限定理（CLT），时间序列数据就没有这么简单，样本之间的关系还粘粘乎乎的。
14. 简单粗暴地将中心极限定义套到时间序列上面行不行？即，如果新来的样本点不满足历史正态分布，就是异常。
     不行，看两个反例：

- 反例1-周期性凸起：新来的样本不满足正态分布，但是正常
- 反例2-局部拐点：新来的样本满足正态分布，但是异常

15. 还是想补救一下，能不能认为，排除掉了周期性凸起和局部拐点之后，就满足中心极限定理了？或者切换到一个更简单清晰的视角，不用中心极限定理，而用常见的时间序列模式描述？例如arima/stl模型等，也不能很理想地解决这两个问题。

> stl模型假设时间序列是由周期性 + 趋势性 + 高斯噪声 三部分组成，相关的参数可以从历史数据中估计出来。估计出来参数后，假设新的正常数据中，趋势性保持，周期性往复，高斯噪声依旧无规律，于是可以生成一个预测的分布，然后看新来的数据是否落入这个区间
> stl模型能否表达周期性凸起和抹掉局部拐点呢？不行，因为周期性凸起一般波动非常大，算法很难精准拟合，毕竟要照顾其他大部分平庸之辈的拟合程度，一般给的预测的置信区间太都很大，所以局部拐点告不出来。

16. 周期性凸起和局部拐点对与很多算法来说，是两个不相容的问题，解决了一个就忽略了另外一个。通常针对不相容的问题，可采用blending的思路，即构建一个复合的策略，多个子策略投票，或者取并集。blending的策略本来也是可以通过数据学习出来的（AdaBoosting和GradientBoosting就是）
1. 以周期性凸起和局部拐点为例，可以构建2个子策略：一个基于环比的子策略用来检测突升/突降，一个基于同比的子策略检测用来屏蔽周期性告警。然后对这个两个子策略构建路由：
   1. if 突升/突降 & 周期性，不告警
   2. if 突升/突降 & 非 周期性，告警【特殊】
   3. if 非 突升/突降 &  周期性，不告警
   4. if 非 突升/突降 & 非 周期性，告警
18. 为什么要用ewma去检测局部平稳性，而不用ma呢？ewma比ma更适合表达趋势。
9. 需求还是方案？怎么给一个合适的阈值？怎么给一个合适的窗口？这个是一个需求？（用户定）还是一个解决方案？（给最佳实践）
10. 如果训练集代表的群体只是总体的子集，我们就只能找到疑似异常。这种情况下，单纯的数据挖掘是获取不到可信的知识的，还需要交给人来确定。就像做图像分类，训练集是动物世界中的动物，测试的时候，给了一个孙悟空，模型就不认识了。这种任务就不应该交给算法，应该转交给更高级的人类去处理，他有样本外的知识，有动画和真实世界这两个概念。
21. 用预测的方法，去做曲线模式判断，用拟合程度来判断符合哪个模式，即找到最佳视角能够解释这个现象，然后采用历史外推的方式，估算出正常区间
22. 更进一步的，正常区间之外，想要找出某个类型的异常，就再次配置出异常类型。
23. 使用邻近窗口的高斯检测器，要注意，这个方法忽略了时间序列的趋势性。
24. 使用ewma，或者曲线拟合出趋势，可以弥补1的问题。
25. 经过验证，ewma局部 + 屏蔽周期告警 的组合策略可以搞定大部分时序场景。



