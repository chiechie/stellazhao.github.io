---
title: Java和虚拟机
author: chiechie
mathjax: true
date: 2021-03-22 10:02:13
tags:
- 计算机原理
- 虚拟机
- 故障诊断
- 读书笔记
categories:
- 编程
---



## JVM的自动内存管理

![JVM运行时的数据区](./img.png)

- 程序计数器（Program Counter Register）是一块较小的内存空间，分支、循环、跳转、异常处理、线程恢复等基础功能都需要依赖这个计数器来完成。是线程私有。
- Java虚拟机栈（Java Virtual Machine Stacks）描述的是Java方法执行的内存模型，每个方法在执行的同时都会创建一个栈帧（Stack Frame)[插图]用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每一个方法从调用直至执行完成的过程，就对应着一个栈帧在虚拟机栈中入栈到出栈的过程。也是线程私有的，生命周期和线程一样。有人把Java内存区分为堆内存（Heap）和栈内存（Stack）
- 本地方法栈（Native Method Stack）跟 Java虚拟机栈类似。区别是，虚拟机栈为虚拟机执行Java方法（也就是字节码）服务，而本地方法栈则为虚拟机使用到的Native方法服务。
- Java堆（Java Heap）是被所有线程共享的一块内存区域，是Java虚拟机所管理的内存中最大的一块。Java堆是垃圾收集器管理的主要区域，因此很多时候也被称做“GC堆”（Garbage Collected Heap）。
- 方法区（Method Area）也是各个线程共享的内存区域，它用于存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据，


## OOM异常

Java虚拟机中，很多区域的问题，都会导致内存溢出(OOM)的异常



## Java的技术体系

1. Java的技术体系包括：虚拟机，Java API，Java编程语言和第三方框架

![图1-Java的技术体系](dl-framework/img.png)

2. 虚拟机层隐藏了基层技术的复杂性，以及操作系统和机器的差异性。运行的程序的物理机器千差万别，而JVM则在千差万别的物理机器上构建了统一的运行平台，实现了，在任意一台虚拟机上变异的程序都能在任何一台虚拟机上运行。这使得java应用的开发比传统c应用的开发更加高效，程序员可以把主要经历集中在具体业务逻辑上，而不是物理硬件的兼容性上。一般情况下，一个程序员只要了解Java API，Java愈发，以及学习适当的第三方开发框架，就能满足日常开发的需要了，虚拟机会在用户不知不觉中完成对硬件平台的兼容以及对内存等资源的管理工作。了解虚拟机的额运作并不是一般开发人员必须掌握的知识。
3. 然而，凡事都具备两面性，java被应用到更多的领域之后，暴露了其在稳定性方面的问题。Java程序很可能在10个人同时使用时正常，但是在1万个人同时使用的时候就会缓慢，死锁。要满足1万个人同时使用，需要更高性能的物理硬件，但是在绝大多数情况下，提升硬件效能无法等比例地提升程序的运作性能和并发能力，甚至可能对程序的运作状况完全没有任何改善（这个有点像做一个创新项目，不断地砸钱，加人不一定能等比例地看到效果），卡住性能的原因有两个：
   - java虚拟机：为了给所有硬件提供一致的虚拟平台，牺牲了一些与硬件相关的性能
   - java开发人员：如果开发人员不了解虚拟机的技术特性，运行原理，就无法写出最适合虚拟机运行的代码。
4. 目前商用的高性能Java虚拟机，都提供了相当多的优化特性，用于满足应用程序对性能和稳定性的要求。
  
## 延伸阅读-关于JRE和JDK

- JRE： Java Runtime EnvironmentJDK，JRE是java运行时环境，包含了java虚拟机，java基础类库。是使用java语言编写的程序运行所需要的软件环境，是提供给想运行java程序的用户使用的。

- JDK：Java Development Kit，JDK是java开发工具包，是程序员使用java语言编写java程序所需的开发工具包，是提供给程序员使用的。JDK包含了JRE，同时还包含了编译java源码的编译器javac，还包含了很多java程序调试和分析的工具：jconsole，jvisualvm等工具软件，还包含了java程序编写所需的文档和demo例子程序。如果你需要运行java程序，只需安装JRE就可以了。如果你需要编写java程序，需要安装JDK。JRE根据不同操作系统（如：windows，linux等）和不同JRE提供商（IBM,ORACLE等）有很多版本，最常用的是Oracle公司收购SUN公司的JRE版本。

类似，JRE就是一个python解释器，JDK是Pycharm

## chiechie's reflection

1. 一个运营人员，只要了解MLSql语法，就能满足日常开发的需要。
数据平台后台会在不知不觉中，完成对不同AI框架的兼容，了解底层的框架细节并不是一般运营人员必须掌握的知识？？这就是生搬硬套「虚拟机」的概念，主流的AI框架就两个，还要自动适配？

2. 虚拟机存在的背景是，操作系统和物理机器五花八门，构造虚拟机有规模效应：

    - 没有虚拟机的时候，10个操作系统，实现1个应用，要开发10个Java版本；实现100个应用，要开发1000个Java版本，开发成本 = 应用个数  * 操作系统的类别
    - 有了虚拟机，10个操作系统，我只用开发10个JVM；实现100个应用，我也只用开发100个Java版本。开发成本 = 应用个数 + 操作系统的类别

3. 随着应用个数爆发式增长，有虚拟机方式的开发成本要比没有虚拟机的开发成本少一个倍数（就是市面上操作系统的个数）。
操作系统的类别如果就1个，这么做成本并不会减少，并且会新增一部分协作带来的成本：本来一个算法工程师能搞定的代码，硬要拆分成两个人去做，拆分和沟通都需要成本吗，并且收益也不明显。

这也能论证，生产发展到一定水平，会出现分工：一部分人去开发底层的虚拟机，一部分人去开发上层的应用。

4. 高级开发 要了解Java虚拟机底层原理。 初级开发只要会用java和api就好了，开发应用就好了。初级和高级的人员分布是金字塔形状。
算法也一样， 初级算法工程师，只用了解调包就好，高级算法要了解算法原理，毕竟有一些难题，只知道调包搞不定，可能要改造下算法，有时候，还要了解底层代码的实现，然后再次开发，来提升性能。



## 参考
1. [深入理解JVM-微信读书](https://weread.qq.com/web/reader/9b832f305933f09b86bd2a9kecc32f3013eccbc87e4b62e)
2. [JRE 和 JDK 的区别是什么？知乎](https://www.zhihu.com/question/20317448/answer/14737358)

1. [深入理解JVM-微信读书](https://weread.qq.com/web/reader/9b832f305933f09b86bd2a9)
